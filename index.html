<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Politiska uppdrag 2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#1f2937}
    .header{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);padding:.6rem 0;position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,255,255,.2)}
    .header-content{max-width:1100px;margin:0 auto;padding:0 1rem;display:flex;justify-content:space-between;align-items:center;gap:.75rem}
    .logo{height:30px}
    .logo img{height:100%;width:auto;object-fit:contain}
    .progress-container{display:flex;align-items:center;gap:.6rem;white-space:nowrap}
    .progress-text{font-weight:500;color:#475569;font-size:.9rem}
    .progress-bar{width:140px;height:6px;background:#e2e8f0;border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#4c51bf,#667eea);border-radius:999px;transition:width .25s ease;width:0%}
    .container{max-width:1100px;margin:0 auto;padding:1rem}
    .welcome{display:flex;align-items:center;justify-content:space-between;gap:1rem;background:rgba(255,255,255,.9);border-radius:14px;padding:1rem 1.25rem;margin:0 0 12px 0}
    .welcome h1{font-size:1.25rem;font-weight:700;background:linear-gradient(135deg,#4c51bf,#667eea);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .welcome p{color:#64748b;font-size:.95rem}
    .quick-actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .chip{border:1px solid #e2e8f0;background:#fff;border-radius:999px;padding:.35rem .75rem;font-size:.85rem;color:#334155}
    .list{display:grid;grid-template-columns:1fr;gap:.6rem}
    /* Compact accordion */
    details.fact{background:rgba(255,255,255,.94);border:1px solid rgba(226,232,240,.9);border-radius:12px;overflow:hidden}
    details.fact[open]{box-shadow:0 8px 24px rgba(0,0,0,.08)}
    summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem}
    summary::-webkit-details-marker{display:none}
    .badge{background:linear-gradient(135deg,#4c51bf,#667eea);color:#fff;font-weight:700;font-size:.8rem;border-radius:999px;padding:.2rem .55rem}
    .title{flex:1;font-weight:600}
    .done{width:22px;height:22px;border-radius:999px;border:2px solid #e2e8f0;display:flex;align-items:center;justify-content:center;font-size:.85rem}
    .done.ok{background:#10b981;border-color:#10b981;color:#fff}
    .content{padding:.75rem 1rem 1rem 1rem;border-top:1px solid #eef2f7}
    .fact-text{font-size:.95rem;color:#475569;background:#f8fafc;border:1px solid #eef2f7;border-radius:10px;padding:.6rem .75rem;margin:.4rem 0 1rem 0}
    /* Kompakt frågor */
    .q{margin:.6rem 0;padding:.6rem .6rem;border:1px solid #e5e7eb;border-radius:10px;background:rgba(248,250,252,.7)}
    .q.required{border-left:3px solid #dc2626}
    .q h4{display:flex;align-items:center;gap:.45rem;font-size:.95rem;margin-bottom:.35rem;color:#334155}
    .qnum{background:#4c51bf;color:#fff;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem}
    .req{color:#dc2626;font-weight:700}
    .opts{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.25rem}
    .opt{display:inline-flex;align-items:center;gap:.45rem;border:1px solid #e2e8f0;background:#fff;border-radius:999px;padding:.35rem .6rem;cursor:pointer;user-select:none}
    .opt input{accent-color:#4c51bf;transform:scale(1.05)}
    .opt.selected{background:#eef2ff;border-color:#4c51bf}
    textarea{width:100%;min-height:80px;padding:.65rem;border:1px solid #e2e8f0;border-radius:10px;font-family:inherit;font-size:.95rem;resize:vertical;background:#fff}
    textarea:focus{outline:none;border-color:#4c51bf;box-shadow:0 0 0 3px rgba(76,81,191,.12)}
    .btns{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem}
    .btn{padding:.6rem .9rem;border:none;border-radius:10px;font-weight:600;cursor:pointer}
    .primary{background:linear-gradient(135deg,#4c51bf,#667eea);color:#fff}
    .secondary{background:linear-gradient(135deg,#059669,#10b981);color:#fff}
    .ghost{background:#fff;border:1px solid #e2e8f0;color:#334155}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:.5rem;padding:.5rem;border-radius:8px;text-align:center;font-weight:500}
    .ok{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
    .err{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
    .footer-bar{position:sticky;bottom:8px;display:flex;justify-content:flex-end;max-width:1100px;margin:12px auto 0;pointer-events:none}
    .footer-bar .btn{pointer-events:auto}

    /* VISUELL HINT: kort “flash” när nästa öppnas */
    @keyframes flashBorder{0%{box-shadow:0 0 0 0 rgba(76,81,191,.35)}100%{box-shadow:0 0 0 8px rgba(76,81,191,0)}}
    details.fact.flash{animation:flashBorder .6s ease-out 1}

    /* små skärmar */
    @media (max-width:768px){
      .header-content{padding:0 .75rem}
      .progress-bar{width:110px}
      .container{padding:.75rem}
      .welcome{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo">
        <img src="https://karlskoga.se/images/18.17cf90041722ce1749b5e/1640015633047/Karlskoga_liggande.png" alt="Karlskoga kommun">
      </div>
      <div class="progress-container">
        <span class="progress-text">Framsteg: <span id="progress-text">0/0</span></span>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="welcome">
      <div>
        <h1>Politiska uppdrag 2026</h1>
        <p>Kompakt vy – öppna ett uppdrag i taget, spara och hoppa vidare.</p>
      </div>
      <div class="quick-actions">
        <span class="chip" id="jump-next">Nästa ej besvarade ↦</span>
        <span class="chip" id="toggle-all">Expandera alla</span>
      </div>
    </div>

    <div id="list" class="list"></div>

    <div class="footer-bar">
      <button id="global-next" class="btn primary">Spara & nästa ↦</button>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzyiWEx_vT0n5ydQdA3u5C35D-O69JNBLkYGEWfRu8gKGxEsHodujZjYY6EQ9Vxlk0S/exec';

    let sessionId = localStorage.getItem('sessionId');
    if (!sessionId) {
      sessionId = 'user_' + Math.random().toString(36).slice(2,9) + '_' + Date.now();
      localStorage.setItem('sessionId', sessionId);
    }

    let factBoxes = [];
    let completedBoxes = new Set(JSON.parse(localStorage.getItem('completedBoxes') || '[]'));
    // savedAnswers[boxId] = { q1_answer, q2_answer, q3_answer, response_id }
    let savedAnswers = JSON.parse(localStorage.getItem('savedAnswers') || '{}');

    // JSONP helper
    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.round(Math.random()*1e9);
        const script = document.createElement('script');
        const sep = url.includes('?') ? '&' : '?';
        window[cb] = (data) => { delete window[cb]; document.head.removeChild(script); resolve(data); };
        script.onerror = () => { delete window[cb]; document.head.removeChild(script); reject(new Error('JSONP error')); };
        script.src = `${url}${sep}callback=${cb}`;
        document.head.appendChild(script);
      });
    }

    // Load fact boxes
    async function loadFactBoxes(){
      const list = document.getElementById('list');
      list.innerHTML = '<div style="padding:1rem;text-align:center;color:#64748b">Laddar…</div>';
      try{
        const data = await jsonp(`${API_URL}?action=get_fact_boxes`);
        if(Array.isArray(data) && data.length){
          factBoxes = data;
          renderList();
          updateProgress();
          openFirstIncomplete();
        } else {
          list.innerHTML = '<div class="msg err">Kunde inte ladda uppdrag.</div>';
        }
      }catch(e){
        console.error(e);
        list.innerHTML = '<div class="msg err">Tekniskt fel vid laddning.</div>';
      }
    }

    function renderList(){
      const list = document.getElementById('list');
      list.innerHTML = '';
      factBoxes.forEach((box, i) => {
        const boxId = box.box_id;
        const saved = savedAnswers[String(boxId)] || {};
        const done = completedBoxes.has(String(boxId));

        const det = document.createElement('details');
        det.className = 'fact';
        det.id = `fact-${boxId}`;
        // bara första (eller första ej besvarade) öppnas senare via openFirstIncomplete()

        const sum = document.createElement('summary');
        sum.innerHTML = `
          <span class="badge">${boxId}</span>
          <span class="title">${box.title || ''}</span>
          <span class="done ${done ? 'ok':''}" id="st_${boxId}">${done ? '✓':''}</span>
        `;

        const content = document.createElement('div');
        content.className = 'content';
        const q2Opts = (box.q2_options || '').split(',').map(s=>s.trim()).filter(Boolean);
        const q1Opts = (box.q1_options || '').split(',').map(s=>s.trim()).filter(Boolean);

        content.innerHTML = `
          <div class="fact-text">${box.content || ''}</div>

          <div class="q required">
            <h4><span class="qnum">1</span>${box.q1_text} <span class="req">*</span></h4>
            <div class="opts" id="q1c_${boxId}">
              ${q1Opts.map(v=>{
                const checked = saved.q1_answer === v ? 'checked' : '';
                const dis = done ? 'disabled':'';
                const id = `q1_${boxId}_${v.replace(/\s+/g,'_')}`;
                return `
                  <label class="opt ${checked?'selected':''}"><input type="radio" name="q1_${boxId}" id="${id}" value="${v}" ${checked} ${dis}> ${v}</label>
                `;
              }).join('')}
            </div>
            <div style="font-size:.85rem;color:#6b7280;margin-top:.15rem">Obligatorisk fråga</div>
          </div>

          <div class="q">
            <h4><span class="qnum">2</span>${box.q2_text} <span style="font-size:.85rem;color:#6b7280">(valfritt)</span></h4>
            <div class="opts" id="q2c_${boxId}">
              ${q2Opts.map(v=>{
                const checked = (saved.q2_answer || '').split(',').map(s=>s.trim()).includes(v) ? 'checked' : '';
                const dis = done ? 'disabled':'';
                const id = `q2_${boxId}_${v.replace(/\s+/g,'_')}`;
                return `
                  <label class="opt ${checked?'selected':''}"><input type="checkbox" name="q2_${boxId}" id="${id}" value="${v}" ${checked} ${dis}> ${v}</label>
                `;
              }).join('')}
            </div>
          </div>

          <div class="q">
            <h4><span class="qnum">3</span>${box.q3_text} <span style="font-size:.85rem;color:#6b7280">(valfritt)</span></h4>
            <textarea id="q3_${boxId}" rows="3" ${done?'disabled':''}>${saved.q3_answer || ''}</textarea>
          </div>

          <div class="btns">
            <button class="btn primary" id="btn_submit_${boxId}" onclick="submitAnswers(${boxId})" style="${done?'display:none':''}">Spara</button>
            <button class="btn secondary" id="btn_edit_${boxId}" onclick="editAnswers(${boxId})" style="${done?'':'display:none'}">Redigera</button>
            <button class="btn ghost" onclick="saveAndNext(${boxId})">Spara & nästa ↦</button>
          </div>
          <div class="msg" id="msg_${boxId}" style="display:none"></div>
        `;

        det.appendChild(sum);
        det.appendChild(content);
        list.appendChild(det);
      });

      // pill-selected styling
      document.querySelectorAll('.opt input[type="radio"]').forEach(inp=>{
        if(inp.checked) inp.closest('.opt').classList.add('selected');
        inp.addEventListener('change', function(){
          const name = this.name;
          document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.closest('.opt')?.classList.remove('selected'));
          this.closest('.opt')?.classList.add('selected');
        });
      });
      document.querySelectorAll('.opt input[type="checkbox"]').forEach(inp=>{
        if(inp.checked) inp.closest('.opt').classList.add('selected');
        inp.addEventListener('change', function(){
          this.closest('.opt')?.classList.toggle('selected', this.checked);
        });
      });

      // Expandera-funktion
      document.getElementById('toggle-all').onclick = () => {
        const all = Array.from(document.querySelectorAll('details.fact'));
        const anyClosed = all.some(d => !d.open);
        all.forEach(d => d.open = anyClosed); // öppna alla om någon är stängd, annars stäng alla
      };

      document.getElementById('jump-next').onclick = () => jumpToNextIncomplete();

      document.getElementById('global-next').onclick = () => {
        // försök spara den öppna rutan om någon är öppen och q1 ifylld, annars hoppa
        const open = document.querySelector('details.fact[open]');
        if (!open) return jumpToNextIncomplete();
        const boxId = Number(open.id.replace('fact-',''));
        saveAndNext(boxId);
      };

      // endast en åt gången (accordion)
      document.querySelectorAll('details.fact').forEach(d=>{
        d.addEventListener('toggle', e=>{
          if(d.open){
            document.querySelectorAll('details.fact').forEach(o=>{ if(o!==d) o.open=false; });
          }
        });
      });
    }

    function showMsg(boxId, text, ok=true){
      const el = document.getElementById(`msg_${boxId}`);
      el.className = `msg ${ok?'ok':'err'}`;
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, 2000);
    }

    async function submitAnswers(boxId){
      const q1 = document.querySelector(`input[name="q1_${boxId}"]:checked`)?.value || '';
      const q2 = Array.from(document.querySelectorAll(`input[name="q2_${boxId}"]:checked`)).map(cb=>cb.value).join(', ');
      const q3 = document.getElementById(`q3_${boxId}`).value || '';
      if(!q1){ showMsg(boxId,'⚠️ Fråga 1 är obligatorisk.',false); return; }

      const btn = document.getElementById(`btn_submit_${boxId}`);
      const isUpdate = Boolean(savedAnswers[String(boxId)]?.response_id);
      if(btn){ btn.disabled = true; btn.textContent = isUpdate ? 'Uppdaterar…' : 'Sparar…'; }

      try{
        const payload = {
          action: isUpdate ? 'update_response' : 'save_response',
          timestamp: new Date().toISOString(),
          session_id: sessionId,
          box_id: boxId,
          q1_answer: q1, q2_answer: q2, q3_answer: q3
        };
        if(isUpdate){ payload.response_id = savedAnswers[String(boxId)].response_id; }

        const res = await jsonp(`${API_URL}?` + new URLSearchParams(payload).toString());
        if(res && res.success){
          const responseId = res.response_id || savedAnswers[String(boxId)]?.response_id || null;
          savedAnswers[String(boxId)] = { q1_answer:q1, q2_answer:q2, q3_answer:q3, response_id:responseId };
          localStorage.setItem('savedAnswers', JSON.stringify(savedAnswers));

          completedBoxes.add(String(boxId));
          localStorage.setItem('completedBoxes', JSON.stringify(Array.from(completedBoxes)));

          // lås inputs
          const fact = document.getElementById(`fact-${boxId}`);
          fact.querySelectorAll('input, textarea').forEach(el=> el.disabled = true);

          // knappar
          const submitBtn = document.getElementById(`btn_submit_${boxId}`);
          const editBtn = document.getElementById(`btn_edit_${boxId}`);
          if(submitBtn) submitBtn.style.display = 'none';
          if(editBtn)   editBtn.style.display   = 'inline-block';

          // status
          const st = document.getElementById(`st_${boxId}`);
          st.classList.add('ok'); st.textContent = '✓';

          showMsg(boxId, isUpdate ? '✅ Svar uppdaterat!' : '✅ Svar sparat!');
          updateProgress();

          // visa final om allt klart
          if(completedBoxes.size === factBoxes.length){
            // öppna inte popup – låt progress visa 100% och behåll flowet
          }
          return true;
        }else{
          showMsg(boxId, `❌ ${res?.error || 'Kunde inte spara svar'}`, false);
          return false;
        }
      }catch(e){
        console.error(e);
        showMsg(boxId, '❌ Tekniskt fel. Försök igen.', false);
        return false;
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = isUpdate ? 'Uppdatera' : 'Spara'; }
      }
    }

    function editAnswers(boxId){
      const fact = document.getElementById(`fact-${boxId}`);
      fact.open = true;
      fact.querySelectorAll('input, textarea').forEach(el=> el.disabled = false);
      // visa Spara-knapp igen, göm Redigera
      const submitBtn = document.getElementById(`btn_submit_${boxId}`);
      const editBtn = document.getElementById(`btn_edit_${boxId}`);
      if(submitBtn){ submitBtn.style.display='inline-block'; submitBtn.textContent='Uppdatera'; }
      if(editBtn){ editBtn.style.display='none'; }
      showMsg(boxId, '🔧 Redigeringsläge aktiverat.');
    }

    async function saveAndNext(currentId){
      const ok = await submitAnswers(currentId);
      if(ok) jumpToNextIncomplete(currentId);
    }

    function jumpToNextIncomplete(fromId=null){
      const ids = factBoxes.map(b => b.box_id);
      let startIndex = 0;
      if(fromId!==null){
        const idx = ids.indexOf(fromId);
        startIndex = (idx>=0 ? idx+1 : 0);
      }
      // hitta första ej besvarade efter current, wrap runt
      const rotated = ids.slice(startIndex).concat(ids.slice(0,startIndex));
      const next = rotated.find(id => !completedBoxes.has(String(id)));
      if(next===undefined){
        // allt klart – öppna första för ev. ändring
        if(ids.length) {
          const d = document.getElementById(`fact-${ids[0]}`);
          if(d){ 
            d.open = true; 
            d.classList.add('flash'); 
            setTimeout(()=>d.classList.remove('flash'), 650);
          }
        }
        return;
      }
      const det = document.getElementById(`fact-${next}`);
      if(det){
        det.open = true;
        det.classList.add('flash');
        setTimeout(()=>det.classList.remove('flash'), 650);
      }
    }

    function openFirstIncomplete(){
      const first = factBoxes.map(b=>b.box_id).find(id => !completedBoxes.has(String(id)));
      const toOpen = first ?? (factBoxes[0]?.box_id);
      if(toOpen!=null){
        const d = document.getElementById(`fact-${toOpen}`);
        if(d) d.open = true;
      }
    }

    function updateProgress(){
      const completed = completedBoxes.size;
      const total = factBoxes.length;
      const pct = total ? (completed/total)*100 : 0;
      document.getElementById('progress-text').textContent = `${completed}/${total}`;
      document.getElementById('progress-fill').style.width = `${pct}%`;
    }

    // go
    loadFactBoxes();
  </script>
</body>
</html>
