<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard - Politiska Uppdrag | Karlskoga kommun</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#f8fafc;color:#1e293b;line-height:1.6}
    .header{background:#fff;border-bottom:1px solid #e2e8f0;padding:1rem 0;position:sticky;top:0;z-index:100;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .header-content{max-width:1400px;margin:0 auto;padding:0 2rem;display:flex;justify-content:space-between;align-items:center}
    .logo{height:40px}
    .logo img{height:100%;width:auto;object-fit:contain}
    .admin-title{font-size:1.5rem;font-weight:600;color:#1e293b}
    .header-actions{display:flex;gap:1rem;align-items:center}
    .refresh-btn{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:500;transition:all .3s ease;display:flex;align-items:center;gap:.5rem}
    .refresh-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(16,185,129,.3)}
    .refresh-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
    .container{max-width:1400px;margin:0 auto;padding:2rem}
    .filter-panel{background:#fff;border-radius:16px;padding:2rem;margin-bottom:2rem;box-shadow:0 4px 6px rgba(0,0,0,.05)}
    .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-top:1.5rem}
    .filter-group{display:flex;flex-direction:column;gap:.5rem}
    .filter-label{font-weight:600;color:#374151;font-size:.9rem}
    .filter-select{padding:.75rem;border:2px solid #e2e8f0;border-radius:8px;font-size:.9rem;background:#fff;transition:border-color .2s ease}
    .filter-select:focus{outline:none;border-color:#3b82f6}
    .filter-checkbox-group{display:flex;flex-wrap:wrap;gap:1rem;margin-top:.5rem}
    .filter-checkbox{display:flex;align-items:center;gap:.5rem;padding:.5rem;background:#f8fafc;border-radius:6px;cursor:pointer;transition:background-color .2s ease}
    .filter-checkbox:hover{background:#e2e8f0}
    .filter-checkbox input[type="checkbox"]{transform:scale(1.2);accent-color:#3b82f6}
    .stats-overview{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
    .stat-card{background:#fff;padding:1.5rem;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);border-left:4px solid #3b82f6}
    .stat-card.primary{border-left-color:#3b82f6}
    .stat-card.success{border-left-color:#10b981}
    .stat-card.warning{border-left-color:#f59e0b}
    .stat-card.info{border-left-color:#06b6d4}
    .stat-number{font-size:2rem;font-weight:700;color:#1e293b;margin-bottom:.5rem}
    .stat-label{color:#64748b;font-size:.9rem}
    .card{background:#fff;border-radius:16px;padding:2rem;box-shadow:0 4px 6px rgba(0,0,0,.05);border:1px solid #e2e8f0;margin-bottom:2rem}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid #f1f5f9}
    .card-title{font-size:1.25rem;font-weight:600;color:#1e293b}
    .card-subtitle{color:#64748b;font-size:.9rem;margin-top:.25rem}
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:2rem;margin-bottom:2rem}
    .chart-container{position:relative;height:350px;margin:1rem 0}
    .responsibility-matrix{overflow-x:auto;max-height:600px;overflow-y:auto;position:relative}
    .matrix-table{width:100%;border-collapse:collapse;min-width:800px}
    .matrix-table th,.matrix-table td{padding:1rem;text-align:center;border:1px solid #e2e8f0}
    .matrix-table th{background:#f8fafc;font-weight:600;color:#374151;position:sticky;top:0;z-index:10}
    .matrix-table td{background:#fff}
    .matrix-table tbody th{position:sticky;left:0;background:#f8fafc;z-index:5;font-weight:600}
    .matrix-table tbody td:first-child{position:sticky;left:0;background:#fff;z-index:5;font-weight:600;text-align:left}
    .matrix-cell{display:flex;align-items:center;justify-content:center;gap:.5rem}
    .responsibility-badge{padding:.25rem .75rem;border-radius:20px;font-size:.8rem;font-weight:500}
    .badge-main{background:#dbeafe;color:#1e40af}
    .badge-support{background:#d1fae5;color:#065f46}
    .text-responses{max-height:400px;overflow-y:auto;padding:1rem 0}
    .response-item{background:#f8fafc;padding:1.5rem;border-radius:8px;margin-bottom:1rem;border-left:4px solid #e2e8f0;position:relative}
    .response-item:hover{border-left-color:#3b82f6;background:#f1f5f9}
    .response-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;font-size:.85rem;color:#64748b}
    .response-tags{display:flex;gap:.5rem;flex-wrap:wrap}
    .response-tag{background:#e2e8f0;color:#475569;padding:.25rem .5rem;border-radius:4px;font-size:.75rem}
    .response-text{color:#374151;line-height:1.5}
    .insight-panel{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:2rem;border-radius:16px;margin-bottom:2rem}
    .insight-title{font-size:1.5rem;font-weight:600;margin-bottom:1rem}
    .insights-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem}
    .insight-card{background:rgba(255,255,255,.1);padding:1.5rem;border-radius:12px;backdrop-filter:blur(10px)}
    .insight-icon{font-size:2rem;margin-bottom:.5rem}
    .insight-text{font-size:.9rem;line-height:1.4}
    .export-section{background:#fff;border-radius:16px;padding:2rem;margin-bottom:2rem;box-shadow:0 4px 6px rgba(0,0,0,.05)}
    .export-buttons{display:flex;gap:1rem;flex-wrap:wrap}
    .export-btn{background:#6366f1;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:500;transition:all .3s ease}
    .export-btn:hover{background:#4f46e5;transform:translateY(-1px)}
    .loading{text-align:center;padding:3rem;color:#64748b}
    .spinner{width:40px;height:40px;border:4px solid #f3f4f6;border-top:4px solid #3b82f6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .error{background:#fef2f2;color:#dc2626;padding:1rem;border-radius:8px;border:1px solid #fecaca;margin:1rem 0}
    .debug-info{background:#f0f9ff;border:1px solid #0284c7;padding:1rem;border-radius:8px;margin:1rem 0;font-family:monospace;font-size:0.8rem}
    .uppdrag-selector{margin-bottom:2rem}
    .uppdrag-tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem}
    .tab{padding:.75rem 1.5rem;background:#f1f5f9;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;transition:all .2s ease;position:relative}
    .tab.active{background:#3b82f6;color:#fff}
    .tab:hover:not(.active){background:#e2e8f0}
    .tab-badge{position:absolute;top:-8px;right:-8px;background:#10b981;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:600}
    .success-message{background:#f0fdf4;color:#15803d;padding:1rem;border-radius:8px;border:1px solid #bbf7d0;margin:1rem 0}
    @media (max-width:768px){
      .container{padding:1rem}
      .dashboard-grid{grid-template-columns:1fr}
      .filter-grid{grid-template-columns:1fr}
      .stats-overview{grid-template-columns:repeat(2,1fr)}
      .header-content{padding:0 1rem;flex-direction:column;gap:1rem}
      .admin-title{font-size:1.25rem}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo">
        <img src="https://karlskoga.se/images/18.17cf90041722ce1749b5e/1640015633047/Karlskoga_liggande.png" alt="Karlskoga kommun">
      </div>
      <div class="admin-title">Dashboard - Fördelning av Politiska Uppdrag</div>
      <div class="header-actions">
        <button class="refresh-btn" id="refresh-button" onclick="loadAllData()">🔄 Uppdatera data</button>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- Debug-information -->
    <div id="debug-info" class="debug-info" style="display:none;">
      <h4>Debug-information:</h4>
      <div id="debug-content"></div>
    </div>

    <!-- Felmeddelanden -->
    <div id="error-messages"></div>

    <!-- Övergripande statistik -->
    <div class="stats-overview">
      <div class="stat-card primary">
        <div class="stat-number" id="total-assignments">-</div>
        <div class="stat-label">Besvarade politiska uppdrag</div>
      </div>
      <div class="stat-card success">
        <div class="stat-number" id="total-responses">-</div>
        <div class="stat-label">Totalt antal svar</div>
      </div>
      <div class="stat-card info">
        <div class="stat-number" id="unique-participants">-</div>
        <div class="stat-label">Antal respondenter</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-number" id="avg-main-consensus">-</div>
        <div class="stat-label">Genomsnittlig huvudkonsensus</div>
      </div>
      <div class="stat-card info">
        <div class="stat-number" id="avg-support-consensus">-</div>
        <div class="stat-label">Genomsnittlig stödkonsensus</div>
      </div>
    </div>

    <!-- AI-genererade insikter -->
    <div class="insight-panel">
      <div class="insight-title">🎯 Strategiska insikter för ledningen</div>
      <div class="insights-grid" id="insights-grid"></div>
    </div>

    <!-- Pedagogisk förklaring av konsensusberäkning -->
    <div class="card" style="background: linear-gradient(135deg, #e0f2fe, #f0f9ff); border-left: 4px solid #0284c7; margin-bottom: 1rem;">
      <div style="padding: 1rem;">
        <details>
          <summary style="cursor: pointer; font-weight: 600; color: #0c4a6e; margin-bottom: 0.5rem;">
            📊 Hur beräknas konsensus? (klicka för att läsa mer)
          </summary>
          <div style="color: #0f172a; line-height: 1.6; font-size: 0.9rem; margin-top: 1rem;">
            <p><strong>Konsensus visar hur eniga respondenterna är</strong> - inte om svaren är "rätta" eller "fel".</p>
            <br>
            <p><strong>Beräkning:</strong> Konsensus = (Antal som valde det populäraste svaret / Totalt antal svar) × 100</p>
            <br>
            <p><strong>Exempel:</strong> Om 10 personer svarar och 7 av dem säger kommunledningskontoret ska ha huvudansvaret, blir konsensus 70%.</p>
            <br>
            <p><strong>Tolkning:</strong></p>
            <ul style="margin: 0.5rem 0 0 1.5rem;">
              <li>🟢 <strong>Hög konsensus (80%+):</strong> Bred enighet, färdigt för beslut</li>
              <li>🟡 <strong>Medel konsensus (50-79%):</strong> Viss enighet, kan behöva diskussion</li>
              <li>🔴 <strong>Låg konsensus (&lt;50%):</strong> Delade meningar, kräver mer utredning</li>
            </ul>
          </div>
        </details>
      </div>
    </div>

    <!-- Uppdragsväljare -->
    <div class="uppdrag-selector">
      <h3>Välj politiskt uppdrag för detaljanalys</h3>
      <div class="uppdrag-tabs" id="uppdrag-tabs"></div>
    </div>

    <!-- Kommentarer -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Kommentarer och förslag</div>
          <div class="card-subtitle">Ytterligare synpunkter från cheferna</div>
        </div>
      </div>
      <div class="text-responses" id="text-responses">
        <div class="loading">
          <div class="spinner"></div>
          Laddar kommentarer...
        </div>
      </div>
    </div>

    <!-- Ansvarsmatris -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Ansvarsmatris - Översikt alla uppdrag</div>
          <div class="card-subtitle">Huvudansvar (H) och stödförvaltningar (S) per uppdrag. Färgkodning: 🟢 Hög konsensus (80%+) 🟡 Medel (50-79%) 🔴 Låg (&lt;50%)</div>
        </div>
      </div>
      <div class="responsibility-matrix">
        <table class="matrix-table" id="responsibility-matrix"></table>
      </div>
    </div>

    <!-- Export-sektion -->
    <div class="export-section">
      <h3>📊 Export och rapporter</h3>
      <p class="card-subtitle">Ladda ner analyser för beslutsmöten</p>
      <div class="export-buttons">
        <button class="export-btn" onclick="exportResponsibilityMatrix()">📋 Ansvarsmatris (Excel)</button>
        <button class="export-btn" onclick="exportDetailedAnalysis()">📊 Detaljerad analys (CSV)</button>
        <button class="export-btn" onclick="exportExecutiveSummary()">📄 Chefssammanfattning (PDF)</button>
        <button class="export-btn" onclick="exportConsensusReport()">🎯 Konsensusrapport</button>
      </div>
    </div>

    <div class="loading" id="main-loading">
      <div class="spinner"></div>
      <p>Laddar dashboard-data...</p>
    </div>

    <!-- Smarta filter -->
    <div class="filter-panel">
      <h3>🔍 Smarta filtreringar</h3>
      <div class="filter-grid">
        <div class="filter-group">
          <label class="filter-label">Filtrera efter huvudansvarig förvaltning:</label>
          <select class="filter-select" id="main-responsibility-filter" onchange="applyFilters()">
            <option value="">Alla förvaltningar</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Filtrera efter stödförvaltningar:</label>
          <div class="filter-checkbox-group" id="support-filter-checkboxes"></div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Konsensusgrad:</label>
          <select class="filter-select" id="consensus-filter" onchange="applyFilters()">
            <option value="">Alla nivåer</option>
            <option value="high">Hög konsensus (80%+)</option>
            <option value="medium">Medel konsensus (50-79%)</option>
            <option value="low">Låg konsensus (&lt;50%)</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Kommentarer:</label>
          <select class="filter-select" id="comment-filter" onchange="applyFilters()">
            <option value="">Alla uppdrag</option>
            <option value="with-comments">Endast med kommentarer</option>
            <option value="without-comments">Endast utan kommentarer</option>
          </select>
        </div>
      </div>
    </div>
  </main>

  <script>
    // API konfiguration
    const API_URL = 'https://script.google.com/macros/s/AKfycbzyiWEx_vT0n5ydQdA3u5C35D-O69JNBLkYGEWfRu8gKGxEsHodujZjYY6EQ9Vxlk0S/exec';

    let allUppdrag = [];
    let allResponses = [];
    let filteredResponses = [];
    let currentUppdragId = 1;
    let charts = {};
    let allFörvaltningar = new Set();
    let debugMode = false; // Sätt till true för debug-output

    // Förbättrad JSONP med timeout och bättre felhantering
    function jsonp(url, timeout = 15000) {
      return new Promise((resolve, reject) => {
        const cb = 'jsonp_callback_' + Math.round(Math.random() * 1e9);
        const script = document.createElement('script');
        const sep = url.includes('?') ? '&' : '?';
        
        const cleanup = () => {
          if (window[cb]) {
            delete window[cb];
          }
          if (script.parentNode) {
            script.parentNode.removeChild(script);
          }
        };
        
        const timer = setTimeout(() => {
          cleanup();
          const error = new Error(`JSONP timeout efter ${timeout}ms för: ${url}`);
          console.error(error.message);
          reject(error);
        }, timeout);
        
        window[cb] = (data) => {
          clearTimeout(timer);
          cleanup();
          if (debugMode) {
            console.log('JSONP svar från:', url, data);
          }
          resolve(data);
        };
        
        script.onerror = (error) => {
          clearTimeout(timer);
          cleanup();
          const err = new Error(`JSONP nätverksfel för: ${url}`);
          console.error(err.message, error);
          reject(err);
        };
        
        script.src = `${url}${sep}callback=${cb}`;
        document.head.appendChild(script);
        
        if (debugMode) {
          console.log('JSONP anrop till:', script.src);
        }
      });
    }

    // Visa felmeddelanden för användaren
    function showError(message, details = null) {
      const container = document.getElementById('error-messages');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.innerHTML = `
        <strong>Fel:</strong> ${message}
        ${details ? `<br><small>${details}</small>` : ''}
        <button onclick="this.parentElement.remove()" style="float:right;background:none;border:none;cursor:pointer;">✕</button>
      `;
      container.appendChild(errorDiv);
    }

    // Visa framgångsmeddelanden
    function showSuccess(message) {
      const container = document.getElementById('error-messages');
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.innerHTML = `
        <strong>Framgång:</strong> ${message}
        <button onclick="this.parentElement.remove()" style="float:right;background:none;border:none;cursor:pointer;">✕</button>
      `;
      container.appendChild(successDiv);
      
      // Ta bort efter 5 sekunder
      setTimeout(() => {
        if (successDiv.parentElement) {
          successDiv.remove();
        }
      }, 5000);
    }

    // Debug-funktioner
    function addDebugInfo(info) {
      if (!debugMode) return;
      
      const debugContainer = document.getElementById('debug-info');
      const debugContent = document.getElementById('debug-content');
      
      debugContainer.style.display = 'block';
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML += `<div>[${timestamp}] ${info}</div>`;
    }

    // Ladda all data med förbättrad felhantering
    async function loadAllData() {
      const refreshBtn = document.getElementById('refresh-button');
      
      try {
        // Rensa tidigare felmeddelanden
        document.getElementById('error-messages').innerHTML = '';
        
        // Inaktivera knapp under laddning
        refreshBtn.disabled = true;
        refreshBtn.textContent = '⏳ Laddar...';
        
        document.getElementById('main-loading').style.display = 'block';
        addDebugInfo('Startar laddning av data...');
        
        // Testa API-anslutning först
        addDebugInfo('Testar API-anslutning...');
        
        addDebugInfo('Laddar uppdrag...');
        await loadUppdrag();
        addDebugInfo(`Laddade ${allUppdrag.length} uppdrag`);
        
        addDebugInfo('Laddar alla svar...');
        await loadAllResponses();
        addDebugInfo(`Laddade ${allResponses.length} svar`);
        
        if (allUppdrag.length === 0) {
          throw new Error('Inga uppdrag kunde laddas från API:et');
        }
        
        extractFörvaltningar();
        addDebugInfo(`Extraherade ${allFörvaltningar.size} förvaltningar`);
        
        setupFilters();
        updateOverallStats();
        createUppdragTabs();
        await ensureCurrentTabVisibleAndLoad();
        generateInsights();
        createResponsibilityMatrix();
        
        showSuccess('Data laddades framgångsrikt!');
        addDebugInfo('All data laddad framgångsrikt');
        
      } catch (error) {
        console.error('Detaljerat fel vid laddning:', error);
        
        const errorMessage = error.message || 'Okänt fel uppstod';
        showError('Kunde inte ladda data från servern', errorMessage);
        
        document.getElementById('main-loading').innerHTML = `
          <div class="error">
            <h4>Fel vid laddning av data</h4>
            <p>${errorMessage}</p>
            <p>Kontrollera att:</p>
            <ul>
              <li>Internetanslutningen fungerar</li>
              <li>API:et är tillgängligt</li>
              <li>Inga annonsblockerare blockerar förfrågan</li>
            </ul>
            <button onclick="loadAllData()" style="margin-top:1rem;padding:0.5rem 1rem;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;">
              Försök igen
            </button>
          </div>
        `;
        
        addDebugInfo(`FEL: ${errorMessage}`);
        
      } finally {
        // Återställ knapp
        refreshBtn.disabled = false;
        refreshBtn.textContent = '🔄 Uppdatera data';
        
        document.getElementById('main-loading').style.display = 'none';
      }
    }

    // Ladda uppdrag med förbättrad felhantering
    async function loadUppdrag() {
      try {
        const data = await jsonp(`${API_URL}?action=get_fact_boxes`);
        
        if (Array.isArray(data)) {
          allUppdrag = data;
          addDebugInfo(`API returnerade ${data.length} uppdrag`);
        } else if (data === null) {
          throw new Error('API returnerade null - möjligt timeout eller nätverksfel');
        } else {
          throw new Error(`API returnerade oväntat format: ${typeof data}`);
        }
        
      } catch (error) {
        addDebugInfo(`Fel vid laddning av uppdrag: ${error.message}`);
        allUppdrag = [];
        throw new Error(`Kunde inte ladda uppdrag: ${error.message}`);
      }
    }

    // Ladda alla svar med förbättrad felhantering
    async function loadAllResponses() {
      try {
        const data = await jsonp(`${API_URL}?action=get_all_responses`);
        
        if (Array.isArray(data)) {
          const responses = data.map(row => ({
            timestamp: row[0],
            session_id: row[1],
            box_id: row[2],
            huvudansvar: row[3],
            stöd: row[4],
            kommentar: row[5],
            updated_at: row[6] || null
          })).filter(r => r.timestamp && r.session_id);
          
          allResponses = responses;
          filteredResponses = [...allResponses];
          
          addDebugInfo(`Bearbetat ${responses.length} giltiga svar av ${data.length} rader`);
          
        } else if (data === null) {
          throw new Error('API returnerade null - möjligt timeout eller nätverksfel');
        } else {
          throw new Error(`API returnerade oväntat format: ${typeof data}`);
        }
        
      } catch (error) {
        addDebugInfo(`Fel vid laddning av svar: ${error.message}`);
        allResponses = [];
        filteredResponses = [];
        throw new Error(`Kunde inte ladda svar: ${error.message}`);
      }
    }

    // Extrahera alla förvaltningar
    function extractFörvaltningar() {
      allFörvaltningar = new Set();
      allResponses.forEach(response => {
        if (response.huvudansvar) allFörvaltningar.add(response.huvudansvar.trim());
        if (response.stöd) response.stöd.split(',').forEach(f => allFörvaltningar.add(f.trim()));
      });
      // från uppdrag-definitionerna
      allUppdrag.forEach(uppdrag => {
        if (uppdrag.q1_options) uppdrag.q1_options.split(',').forEach(o => allFörvaltningar.add(o.trim()));
        if (uppdrag.q2_options) uppdrag.q2_options.split(',').forEach(o => allFörvaltningar.add(o.trim()));
      });
    }

    // Sätt upp filtreringar
    function setupFilters() {
      const mainFilter = document.getElementById('main-responsibility-filter');
      mainFilter.innerHTML = '<option value="">Alla förvaltningar</option>';
      [...allFörvaltningar].sort().forEach(f => {
        const option = document.createElement('option');
        option.value = f; option.textContent = f; mainFilter.appendChild(option);
      });

      const supportContainer = document.getElementById('support-filter-checkboxes');
      supportContainer.innerHTML = '';
      [...allFörvaltningar].sort().forEach(f => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'filter-checkbox';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox'; checkbox.id = `support-${f}`; checkbox.value = f; checkbox.onchange = applyFilters;
        const label = document.createElement('label');
        label.htmlFor = `support-${f}`; label.textContent = f;
        checkboxDiv.appendChild(checkbox); checkboxDiv.appendChild(label);
        supportContainer.appendChild(checkboxDiv);
      });
    }

    // Tillämpa filtreringar
    async function applyFilters() {
      const mainFilter = document.getElementById('main-responsibility-filter').value;
      const consensusFilter = document.getElementById('consensus-filter').value;
      const commentFilter = document.getElementById('comment-filter').value;

      const selectedSupport = [];
      document.querySelectorAll('#support-filter-checkboxes input[type="checkbox"]:checked').forEach(cb => selectedSupport.push(cb.value));

      filteredResponses = allResponses.filter(response => {
        if (mainFilter && response.huvudansvar !== mainFilter) return false;
        if (selectedSupport.length > 0) {
          const responseSupport = response.stöd ? response.stöd.split(',').map(s => s.trim()) : [];
          const hasMatchingSupport = selectedSupport.some(support => responseSupport.includes(support));
          if (!hasMatchingSupport) return false;
        }
        if (commentFilter === 'with-comments' && (!response.kommentar || !response.kommentar.trim())) return false;
        if (commentFilter === 'without-comments' && (response.kommentar && response.kommentar.trim())) return false;
        return true;
      });

      if (consensusFilter) {
        const filteredUppdragIds = new Set();
        allUppdrag.forEach(uppdrag => {
          const uppdragResponses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
          if (uppdragResponses.length > 0) {
            const consensus = calculateConsensus(uppdragResponses, 'huvudansvar');
            if (consensusFilter === 'high' && consensus >= 80) filteredUppdragIds.add(uppdrag.box_id);
            else if (consensusFilter === 'medium' && consensus >= 50 && consensus < 80) filteredUppdragIds.add(uppdrag.box_id);
            else if (consensusFilter === 'low' && consensus < 50) filteredUppdragIds.add(uppdrag.box_id);
          }
        });
        if (filteredUppdragIds.size > 0) {
          filteredResponses = filteredResponses.filter(r => filteredUppdragIds.has(r.box_id));
        }
      }

      updateOverallStats();
      createResponsibilityMatrix();
      createUppdragTabs();
      await ensureCurrentTabVisibleAndLoad();
      generateInsights();
    }

    // Beräkna konsensus för huvudansvar
    function calculateConsensus(responses, field) {
      if (responses.length === 0) return 0;
      const counts = {}; let maxCount = 0;
      responses.forEach(response => {
        const value = response[field];
        if (value) { counts[value] = (counts[value] || 0) + 1; maxCount = Math.max(maxCount, counts[value]); }
      });
      return Math.round((maxCount / responses.length) * 100);
    }

    // Beräkna stödkonsensus - hur eniga är de om stödfunktioner
    function calculateSupportConsensus(responses) {
      if (responses.length === 0) return 0;
      
      // Samla alla stödförvaltningar från alla svar
      const allSupportMentions = [];
      responses.forEach(response => {
        if (response.stöd && response.stöd.trim()) {
          const supportList = response.stöd.split(',').map(s => s.trim()).filter(Boolean);
          allSupportMentions.push(...supportList);
        }
      });
      
      if (allSupportMentions.length === 0) return 0;
      
      // Räkna hur ofta varje stödförvaltning nämns
      const supportCounts = {};
      allSupportMentions.forEach(support => {
        supportCounts[support] = (supportCounts[support] || 0) + 1;
      });
      
      // Hitta den mest nämnda stödförvaltningen
      const maxSupportCount = Math.max(...Object.values(supportCounts));
      
      // Konsensus = (mest nämnda stödet / antal svar) * 100
      return Math.round((maxSupportCount / responses.length) * 100);
    }

    // Beräkna komplexitet - antal unika förvaltningar som nämns totalt
    function calculateComplexity(responses) {
      const uniqueForvaltningar = new Set();
      
      responses.forEach(response => {
        if (response.huvudansvar) uniqueForvaltningar.add(response.huvudansvar.trim());
        if (response.stöd && response.stöd.trim()) {
          response.stöd.split(',').forEach(s => {
            const trimmed = s.trim();
            if (trimmed) uniqueForvaltningar.add(trimmed);
          });
        }
      });
      
      return uniqueForvaltningar.size;
    }

    // Övergripande statistik med separata konsensus-mätningar
    function updateOverallStats() {
      const uniqueUppdrag = new Set(filteredResponses.map(r => r.box_id)).size;
      const totalResponses = filteredResponses.length;
      const uniqueParticipants = new Set(filteredResponses.map(r => r.session_id)).size;

      let totalMainConsensus = 0;
      let totalSupportConsensus = 0;
      let uppdragWithResponses = 0;
      
      allUppdrag.forEach(uppdrag => {
        const uppdragResponses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (uppdragResponses.length > 0) { 
          totalMainConsensus += calculateConsensus(uppdragResponses, 'huvudansvar');
          totalSupportConsensus += calculateSupportConsensus(uppdragResponses);
          uppdragWithResponses++; 
        }
      });
      
      const avgMainConsensus = uppdragWithResponses > 0 ? Math.round(totalMainConsensus / uppdragWithResponses) : 0;
      const avgSupportConsensus = uppdragWithResponses > 0 ? Math.round(totalSupportConsensus / uppdragWithResponses) : 0;

      document.getElementById('total-assignments').textContent = uniqueUppdrag;
      document.getElementById('total-responses').textContent = totalResponses;
      document.getElementById('unique-participants').textContent = uniqueParticipants;
      document.getElementById('avg-main-consensus').textContent = avgMainConsensus + '%';
      document.getElementById('avg-support-consensus').textContent = avgSupportConsensus + '%';
    }

    // Tabs
    function createUppdragTabs() {
      const tabsContainer = document.getElementById('uppdrag-tabs');
      tabsContainer.innerHTML = '';
      const relevantUppdrag = allUppdrag.filter(uppdrag => filteredResponses.some(r => r.box_id == uppdrag.box_id));
      
      if (relevantUppdrag.length === 0) {
        tabsContainer.innerHTML = '<div class="error">Inga uppdrag matchar de valda filtren.</div>';
        return;
      }
      
      relevantUppdrag.forEach(uppdrag => {
        const responseCount = filteredResponses.filter(r => r.box_id == uppdrag.box_id).length;
        const tab = document.createElement('button');
        tab.className = 'tab';
        tab.textContent = `${uppdrag.title}`;
        tab.onclick = (e) => selectUppdrag(uppdrag.box_id, e);
        if (uppdrag.box_id === currentUppdragId) tab.classList.add('active');
        if (responseCount > 0) {
          const badge = document.createElement('span');
          badge.className = 'tab-badge';
          badge.textContent = responseCount;
          tab.appendChild(badge);
        }
        tabsContainer.appendChild(tab);
      });
    }

    async function ensureCurrentTabVisibleAndLoad() {
      const visibleIds = new Set(filteredResponses.map(r => r.box_id));
      if (!visibleIds.has(currentUppdragId)) {
        const first = [...visibleIds][0];
        if (first != null) currentUppdragId = first;
      }
      await loadUppdragData(currentUppdragId);
      // markera aktiv tab
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      const tabs = [...document.querySelectorAll('.uppdrag-tabs .tab')];
      const idx = allUppdrag.findIndex(u => u.box_id == currentUppdragId);
      // fallback: markera första
      (tabs[idx] || tabs[0])?.classList.add('active');
    }

    async function selectUppdrag(uppdragId, e) {
      currentUppdragId = uppdragId;
      if (e && e.currentTarget) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        e.currentTarget.classList.add('active');
      }
      await loadUppdragData(uppdragId);
    }

    // Ladda data för specifikt uppdrag
    async function loadUppdragData(uppdragId) {
      const uppdrag = allUppdrag.find(u => u.box_id == uppdragId);
      const responses = filteredResponses.filter(r => r.box_id == uppdragId);
      if (!uppdrag || responses.length === 0) {
        document.getElementById('text-responses').innerHTML = '<div class="response-item">Inga svar för detta uppdrag.</div>';
        return;
      }
      displayComments(responses);
    }

    // Visa kommentarer (visar updated_at om finns)
    function displayComments(responses) {
      const container = document.getElementById('text-responses');
      const commentsWithText = responses.filter(r => r.kommentar && r.kommentar.trim());
      if (commentsWithText.length === 0) {
        container.innerHTML = '<div class="response-item">Inga kommentarer för detta uppdrag.</div>';
        return;
      }
      container.innerHTML = commentsWithText.map((response, index) => {
        const dateStr = new Date(response.updated_at || response.timestamp).toLocaleDateString('sv-SE');
        return `
          <div class="response-item">
            <div class="response-meta">
              <div><strong>Deltagare ${index + 1}</strong> • ${dateStr}</div>
              <div class="response-tags">
                <span class="response-tag">Huvudansvar: ${response.huvudansvar || 'Ej angivet'}</span>
                <span class="response-tag">Stöd: ${response.stöd || 'Ej angivet'}</span>
              </div>
            </div>
            <div class="response-text">${response.kommentar}</div>
          </div>
        `;
      }).join('');
    }

    // Skapa ansvarsmatris utan stödkonsensus
    function createResponsibilityMatrix() {
      const table = document.getElementById('responsibility-matrix');
      let headerHtml = '<thead><tr><th>Politiskt Uppdrag</th>';
      const sortedFörvaltningar = [...allFörvaltningar].sort();
      sortedFörvaltningar.forEach(f => { headerHtml += `<th>${f}</th>`; });
      headerHtml += '<th>Huvudkonsensus</th><th>Komplexitet</th></tr></thead>';

      let bodyHtml = '<tbody>';
      const relevantUppdrag = allUppdrag.filter(uppdrag => filteredResponses.some(r => r.box_id == uppdrag.box_id));

      if (relevantUppdrag.length === 0) {
        table.innerHTML = '<tbody><tr><td colspan="100%">Inga uppdrag matchar de valda filtren.</td></tr></tbody>';
        return;
      }

      relevantUppdrag.forEach(uppdrag => {
        const uppdragResponses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (uppdragResponses.length === 0) return;
        bodyHtml += `<tr><td><strong>${uppdrag.title}</strong></td>`;
        sortedFörvaltningar.forEach(f => {
          const mainCount = uppdragResponses.filter(r => r.huvudansvar === f).length;
          const supportCount = uppdragResponses.filter(r => {
            if (!r.stöd) return false;
            const arr = r.stöd.split(',').map(s => s.trim()).filter(Boolean);
            return arr.includes(f);
          }).length;
          let cellContent = '';
          if (mainCount > 0) cellContent += `<span class="responsibility-badge badge-main">H: ${mainCount}</span>`;
          if (supportCount > 0) cellContent += `<span class="responsibility-badge badge-support">S: ${supportCount}</span>`;
          if (!cellContent) cellContent = '-';
          bodyHtml += `<td><div class="matrix-cell">${cellContent}</div></td>`;
        });
        const mainConsensus = calculateConsensus(uppdragResponses, 'huvudansvar');
        const complexity = calculateComplexity(uppdragResponses);
        
        // Färgkoda baserat på konsensus
        const mainColor = mainConsensus >= 80 ? '#10b981' : mainConsensus >= 50 ? '#f59e0b' : '#ef4444';
        const complexityColor = complexity <= 3 ? '#10b981' : complexity <= 5 ? '#f59e0b' : '#ef4444';
        
        bodyHtml += `<td><strong style="color:${mainColor}">${mainConsensus}%</strong></td>`;
        bodyHtml += `<td><strong style="color:${complexityColor}">${complexity}</strong></td></tr>`;
      });
      bodyHtml += '</tbody>';
      table.innerHTML = headerHtml + bodyHtml;
    }

    // Strategiska insikter med utökad analys
    function generateInsights() {
      const consensusLevels = { high: 0, medium: 0, low: 0 };
      const supportConsensusLevels = { high: 0, medium: 0, low: 0 };
      const förvaltningPopularity = {};
      const förvaltningAsSupport = {};
      let totalComplexity = 0;
      let uppdragCount = 0;
      
      allUppdrag.forEach(uppdrag => {
        const responses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (responses.length > 0) {
          uppdragCount++;
          
          // Huvudkonsensus
          const mainConsensus = calculateConsensus(responses, 'huvudansvar');
          if (mainConsensus >= 80) consensusLevels.high++;
          else if (mainConsensus >= 50) consensusLevels.medium++;
          else consensusLevels.low++;
          
          // Stödkonsensus
          const supportConsensus = calculateSupportConsensus(responses);
          if (supportConsensus >= 80) supportConsensusLevels.high++;
          else if (supportConsensus >= 50) supportConsensusLevels.medium++;
          else supportConsensusLevels.low++;
          
          // Komplexitet
          totalComplexity += calculateComplexity(responses);
          
          // Popularitet som huvudansvarig
          responses.forEach(r => { 
            if (r.huvudansvar) förvaltningPopularity[r.huvudansvar] = (förvaltningPopularity[r.huvudansvar] || 0) + 1; 
          });
          
          // Popularitet som stödfunktion
          responses.forEach(r => {
            if (r.stöd) {
              r.stöd.split(',').forEach(support => {
                const trimmed = support.trim();
                if (trimmed) förvaltningAsSupport[trimmed] = (förvaltningAsSupport[trimmed] || 0) + 1;
              });
            }
          });
        }
      });

      const avgComplexity = uppdragCount > 0 ? Math.round(totalComplexity / uppdragCount) : 0;

      const insightsData = [
        { icon: '🎯', text: `Huvudansvar: ${consensusLevels.high} hög konsensus, ${consensusLevels.low} låg konsensus` },
        { icon: '🤝', text: `Stödfunktioner: ${supportConsensusLevels.high} hög konsensus, ${supportConsensusLevels.low} låg konsensus` },
        { icon: '👥', text: `${new Set(filteredResponses.map(r => r.session_id)).size} chefer har deltagit i kartläggningen` }
      ];
      
      if (Object.keys(förvaltningPopularity).length > 0) {
        const mostPopularMain = Object.keys(förvaltningPopularity).reduce((a,b) => förvaltningPopularity[a] > förvaltningPopularity[b] ? a : b);
        insightsData.push({ icon: '🏛️', text: `${mostPopularMain} föreslås som huvudansvarig för flest uppdrag` });
      }
      
      if (Object.keys(förvaltningAsSupport).length > 0) {
        const mostPopularSupport = Object.keys(förvaltningAsSupport).reduce((a,b) => förvaltningAsSupport[a] > förvaltningAsSupport[b] ? a : b);
        const supportCount = förvaltningAsSupport[mostPopularSupport];
        insightsData.push({ icon: '⚠️', text: `${mostPopularSupport} nämns som stöd i ${supportCount} uppdrag - potentiell flaskhals` });
      }
      
      insightsData.push({ icon: '📊', text: `Genomsnittlig komplexitet: ${avgComplexity} förvaltningar per uppdrag` });
      
      const commentsCount = filteredResponses.filter(r => r.kommentar && r.kommentar.trim()).length;
      if (commentsCount > 0) insightsData.push({ icon: '💬', text: `${commentsCount} av ${filteredResponses.length} svar innehåller kommentarer med fördjupade synpunkter` });

      const insightsContainer = document.getElementById('insights-grid');
      insightsContainer.innerHTML = insightsData.map(i => `
        <div class="insight-card">
          <div class="insight-icon">${i.icon}</div>
          <div class="insight-text">${i.text}</div>
        </div>
      `).join('');
    }

    // Exporter
    function exportResponsibilityMatrix() {
      const sortedFörvaltningar = [...allFörvaltningar].sort();
      let csv = 'Politiskt Uppdrag,' + sortedFörvaltningar.join(',') + ',Konsensus\n';
      allUppdrag.forEach(uppdrag => {
        const responses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (responses.length === 0) return;
        csv += `"${uppdrag.title}",`;
        sortedFörvaltningar.forEach(f => {
          const mainCount = responses.filter(r => r.huvudansvar === f).length;
          const supportCount = responses.filter(r => {
            if (!r.stöd) return false;
            const arr = r.stöd.split(',').map(s => s.trim()).filter(Boolean);
            return arr.includes(f);
          }).length;
          let cellValue = '';
          if (mainCount > 0) cellValue += `H:${mainCount}`;
          if (supportCount > 0) cellValue += `${cellValue ? ' ' : ''}S:${supportCount}`;
          if (!cellValue) cellValue = '-';
          csv += `"${cellValue}",`;
        });
        const consensus = calculateConsensus(responses, 'huvudansvar');
        csv += `${consensus}%\n`;
      });
      downloadCSV(csv, 'ansvarsmatris_politiska_uppdrag.csv');
    }

    function exportDetailedAnalysis() {
      let csv = 'Uppdrag,Titel,Deltagare,Huvudansvar,Stödförvaltningar,Kommentar,Datum,Senast uppdaterad\n';
      filteredResponses.forEach(response => {
        const uppdrag = allUppdrag.find(u => u.box_id == response.box_id);
        const ts = response.timestamp ? new Date(response.timestamp).toISOString() : '';
        const up = response.updated_at ? new Date(response.updated_at).toISOString() : '';
        csv += `"${response.box_id}","${uppdrag ? uppdrag.title : 'Okänd'}","${response.session_id}","${response.huvudansvar}","${response.stöd}","${(response.kommentar || '').replace(/"/g,'""')}","${ts}","${up}"\n`;
      });
      downloadCSV(csv, 'detaljerad_analys_politiska_uppdrag.csv');
    }

    function exportExecutiveSummary() {
      alert('PDF-export med chefssammanfattning kommer att implementeras med avancerade insikter och rekommendationer.');
    }

    function exportConsensusReport() {
      let report = 'KONSENSUSRAPPORT - POLITISKA UPPDRAG\n';
      report += `Genererad: ${new Date().toLocaleDateString('sv-SE')}\n\n`;
      allUppdrag.forEach(uppdrag => {
        const responses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (responses.length === 0) return;
        const consensus = calculateConsensus(responses, 'huvudansvar');
        const level = consensus >= 80 ? 'HÖG' : consensus >= 50 ? 'MEDEL' : 'LÅG';
        report += `${uppdrag.title}: ${consensus}% konsensus (${level})\n`;
        const counts = {};
        responses.forEach(r => { if (r.huvudansvar) counts[r.huvudansvar] = (counts[r.huvudansvar] || 0) + 1; });
        Object.entries(counts).sort(([,a],[,b]) => b - a).forEach(([f, count]) => {
          const percentage = Math.round((count / responses.length) * 100);
          report += `  - ${f}: ${count} röster (${percentage}%)\n`;
        });
        report += '\n';
      });
      const blob = new Blob([report], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      a.download = `konsensusrapport_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url);
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url);
    }

    // Starta laddning när sidan är klar
    document.addEventListener('DOMContentLoaded', function() { 
      // Sätt debugMode till true för att se mer information
      // debugMode = true;
      loadAllData(); 
    });
  </script>
</body>
</html>
