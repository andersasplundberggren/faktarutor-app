<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard - Politiska Uppdrag | Karlskoga kommun</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#f8fafc;color:#1e293b;line-height:1.6}
    .header{background:#fff;border-bottom:1px solid #e2e8f0;padding:1rem 0;position:sticky;top:0;z-index:100;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .header-content{max-width:1400px;margin:0 auto;padding:0 2rem;display:flex;justify-content:space-between;align-items:center}
    .logo{height:40px}
    .logo img{height:100%;width:auto;object-fit:contain}
    .admin-title{font-size:1.5rem;font-weight:600;color:#1e293b}
    .header-actions{display:flex;gap:1rem;align-items:center}
    .refresh-btn{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:500;transition:all .3s ease;display:flex;align-items:center;gap:.5rem}
    .refresh-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(16,185,129,.3)}
    .container{max-width:1400px;margin:0 auto;padding:2rem}
    .filter-panel{background:#fff;border-radius:16px;padding:2rem;margin-bottom:2rem;box-shadow:0 4px 6px rgba(0,0,0,.05)}
    .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-top:1.5rem}
    .filter-group{display:flex;flex-direction:column;gap:.5rem}
    .filter-label{font-weight:600;color:#374151;font-size:.9rem}
    .filter-select{padding:.75rem;border:2px solid #e2e8f0;border-radius:8px;font-size:.9rem;background:#fff;transition:border-color .2s ease}
    .filter-select:focus{outline:none;border-color:#3b82f6}
    .filter-checkbox-group{display:flex;flex-wrap:wrap;gap:1rem;margin-top:.5rem}
    .filter-checkbox{display:flex;align-items:center;gap:.5rem;padding:.5rem;background:#f8fafc;border-radius:6px;cursor:pointer;transition:background-color .2s ease}
    .filter-checkbox:hover{background:#e2e8f0}
    .filter-checkbox input[type="checkbox"]{transform:scale(1.2);accent-color:#3b82f6}
    .stats-overview{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
    .stat-card{background:#fff;padding:1.5rem;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);border-left:4px solid #3b82f6}
    .stat-card.primary{border-left-color:#3b82f6}
    .stat-card.success{border-left-color:#10b981}
    .stat-card.warning{border-left-color:#f59e0b}
    .stat-card.info{border-left-color:#06b6d4}
    .stat-number{font-size:2rem;font-weight:700;color:#1e293b;margin-bottom:.5rem}
    .stat-label{color:#64748b;font-size:.9rem}
    .card{background:#fff;border-radius:16px;padding:2rem;box-shadow:0 4px 6px rgba(0,0,0,.05);border:1px solid #e2e8f0;margin-bottom:2rem}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid #f1f5f9}
    .card-title{font-size:1.25rem;font-weight:600;color:#1e293b}
    .card-subtitle{color:#64748b;font-size:.9rem;margin-top:.25rem}
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:2rem;margin-bottom:2rem}
    .chart-container{position:relative;height:350px;margin:1rem 0}
    .responsibility-matrix{overflow-x:auto}
    .matrix-table{width:100%;border-collapse:collapse;min-width:800px}
    .matrix-table th,.matrix-table td{padding:1rem;text-align:center;border:1px solid #e2e8f0}
    .matrix-table th{background:#f8fafc;font-weight:600;color:#374151}
    .matrix-table td{background:#fff}
    .matrix-cell{display:flex;align-items:center;justify-content:center;gap:.5rem}
    .responsibility-badge{padding:.25rem .75rem;border-radius:20px;font-size:.8rem;font-weight:500}
    .badge-main{background:#dbeafe;color:#1e40af}
    .badge-support{background:#d1fae5;color:#065f46}
    .text-responses{max-height:400px;overflow-y:auto;padding:1rem 0}
    .response-item{background:#f8fafc;padding:1.5rem;border-radius:8px;margin-bottom:1rem;border-left:4px solid #e2e8f0;position:relative}
    .response-item:hover{border-left-color:#3b82f6;background:#f1f5f9}
    .response-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;font-size:.85rem;color:#64748b}
    .response-tags{display:flex;gap:.5rem;flex-wrap:wrap}
    .response-tag{background:#e2e8f0;color:#475569;padding:.25rem .5rem;border-radius:4px;font-size:.75rem}
    .response-text{color:#374151;line-height:1.5}
    .insight-panel{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:2rem;border-radius:16px;margin-bottom:2rem}
    .insight-title{font-size:1.5rem;font-weight:600;margin-bottom:1rem}
    .insights-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem}
    .insight-card{background:rgba(255,255,255,.1);padding:1.5rem;border-radius:12px;backdrop-filter:blur(10px)}
    .insight-icon{font-size:2rem;margin-bottom:.5rem}
    .insight-text{font-size:.9rem;line-height:1.4}
    .export-section{background:#fff;border-radius:16px;padding:2rem;margin-bottom:2rem;box-shadow:0 4px 6px rgba(0,0,0,.05)}
    .export-buttons{display:flex;gap:1rem;flex-wrap:wrap}
    .export-btn{background:#6366f1;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:500;transition:all .3s ease}
    .export-btn:hover{background:#4f46e5;transform:translateY(-1px)}
    .loading{text-align:center;padding:3rem;color:#64748b}
    .spinner{width:40px;height:40px;border:4px solid #f3f4f6;border-top:4px solid #3b82f6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .error{background:#fef2f2;color:#dc2626;padding:1rem;border-radius:8px;border:1px solid #fecaca}
    .uppdrag-selector{margin-bottom:2rem}
    .uppdrag-tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem}
    .tab{padding:.75rem 1.5rem;background:#f1f5f9;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;transition:all .2s ease;position:relative}
    .tab.active{background:#3b82f6;color:#fff}
    .tab:hover:not(.active){background:#e2e8f0}
    .tab-badge{position:absolute;top:-8px;right:-8px;background:#10b981;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:600}
    @media (max-width:768px){
      .container{padding:1rem}
      .dashboard-grid{grid-template-columns:1fr}
      .filter-grid{grid-template-columns:1fr}
      .stats-overview{grid-template-columns:repeat(2,1fr)}
      .header-content{padding:0 1rem;flex-direction:column;gap:1rem}
      .admin-title{font-size:1.25rem}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo">
        <img src="https://karlskoga.se/images/18.17cf90041722ce1749b5e/1640015633047/Karlskoga_liggande.png" alt="Karlskoga kommun">
      </div>
      <div class="admin-title">Dashboard - F√∂rdelning av Politiska Uppdrag</div>
      <div class="header-actions">
        <button class="refresh-btn" onclick="loadAllData()">üîÑ Uppdatera data</button>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- √ñvergripande statistik -->
    <div class="stats-overview">
      <div class="stat-card primary">
        <div class="stat-number" id="total-assignments">-</div>
        <div class="stat-label">Besvarade politiska uppdrag</div>
      </div>
      <div class="stat-card success">
        <div class="stat-number" id="total-responses">-</div>
        <div class="stat-label">Totalt antal svar</div>
      </div>
      <div class="stat-card info">
        <div class="stat-number" id="unique-participants">-</div>
        <div class="stat-label">Antal respondenter</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-number" id="avg-consensus">-</div>
        <div class="stat-label">Genomsnittlig konsensus</div>
      </div>
    </div>

    <!-- AI-genererade insikter -->
    <div class="insight-panel">
      <div class="insight-title">üéØ Strategiska insikter f√∂r ledningen</div>
      <div class="insights-grid" id="insights-grid"></div>
    </div>
    
<!-- Pedagogisk f√∂rklaring av konsensusber√§kning -->
    <div class="card" style="background: linear-gradient(135deg, #e0f2fe, #f0f9ff); border-left: 4px solid #0284c7; margin-bottom: 1rem;">
      <div style="padding: 1rem;">
        <details>
          <summary style="cursor: pointer; font-weight: 600; color: #0c4a6e; margin-bottom: 0.5rem;">
            üìä Hur ber√§knas konsensus? (klicka f√∂r att l√§sa mer)
          </summary>
          <div style="color: #0f172a; line-height: 1.6; font-size: 0.9rem; margin-top: 1rem;">
            <p><strong>Konsensus visar hur eniga respondenterna √§r</strong> - inte om svaren √§r "r√§tta" eller "fel".</p>
            <br>
            <p><strong>Ber√§kning:</strong> Konsensus = (Antal som valde det popul√§raste svaret / Totalt antal svar) √ó 100</p>
            <br>
            <p><strong>Exempel:</strong> Om 10 personer svarar och 7 av dem s√§ger "Kommunstyrelsen" ska ha huvudansvaret, blir konsensus 70%.</p>
            <br>
            <p><strong>Tolkning:</strong></p>
            <ul style="margin: 0.5rem 0 0 1.5rem;">
              <li>üü¢ <strong>H√∂g konsensus (80%+):</strong> Bred enighet, f√§rdigt f√∂r beslut</li>
              <li>üü° <strong>Medel konsensus (50-79%):</strong> Viss enighet, kan beh√∂va diskussion</li>
              <li>üî¥ <strong>L√•g konsensus (&lt;50%):</strong> Delade meningar, kr√§ver mer utredning</li>
            </ul>
          </div>
        </details>
      </div>
    </div>

    <!-- √ñvergripande statistik -->
    <div class="stats-overview">
      <div class="stat-card primary">
        <div class="stat-number" id="total-assignments">-</div>
        <div class="stat-label">Besvarade politiska uppdrag</div>
      </div>
      <div class="stat-card success">
        <div class="stat-number" id="total-responses">-</div>
        <div class="stat-label">Totalt antal svar</div>
      </div>
      <div class="stat-card info">
        <div class="stat-number" id="unique-participants">-</div>
        <div class="stat-label">Antal respondenter</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-number" id="avg-consensus">-</div>
        <div class="stat-label">Genomsnittlig konsensus</div>
      </div>
    </div>
    <!-- Uppdragsv√§ljare -->
    <div class="uppdrag-selector">
      <h3>V√§lj politiskt uppdrag f√∂r detaljanalys</h3>
      <div class="uppdrag-tabs" id="uppdrag-tabs"></div>
    </div>

    <!-- Kommentarer -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Kommentarer och f√∂rslag</div>
          <div class="card-subtitle">Ytterligare synpunkter fr√•n cheferna</div>
        </div>
      </div>
      <div class="text-responses" id="text-responses">
        <div class="loading">
          <div class="spinner"></div>
          Laddar kommentarer...
        </div>
      </div>
    </div>

    <!-- Ansvarsmatris -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Ansvarsmatris - √ñversikt alla uppdrag</div>
          <div class="card-subtitle">Huvudansvar och st√∂df√∂rvaltningar per uppdrag</div>
        </div>
      </div>
      <div class="responsibility-matrix">
        <table class="matrix-table" id="responsibility-matrix"></table>
      </div>
    </div>

    <!-- Export-sektion -->
    <div class="export-section">
      <h3>üìä Export och rapporter</h3>
      <p class="card-subtitle">Ladda ner analyser f√∂r beslutsm√∂ten</p>
      <div class="export-buttons">
        <button class="export-btn" onclick="exportResponsibilityMatrix()">üìã Ansvarsmatris (Excel)</button>
        <button class="export-btn" onclick="exportDetailedAnalysis()">üìä Detaljerad analys (CSV)</button>
        <button class="export-btn" onclick="exportExecutiveSummary()">üìÑ Chefssammanfattning (PDF)</button>
        <button class="export-btn" onclick="exportConsensusReport()">üéØ Konsensusrapport</button>
      </div>
    </div>

    <div class="loading" id="main-loading">
      <div class="spinner"></div>
      <p>Laddar dashboard-data...</p>
    </div>

    <!-- Smarta filter -->
    <div class="filter-panel">
      <h3>üîç Smarta filtreringar</h3>
      <div class="filter-grid">
        <div class="filter-group">
          <label class="filter-label">Filtrera efter huvudansvarig f√∂rvaltning:</label>
          <select class="filter-select" id="main-responsibility-filter" onchange="applyFilters()">
            <option value="">Alla f√∂rvaltningar</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Filtrera efter st√∂df√∂rvaltningar:</label>
          <div class="filter-checkbox-group" id="support-filter-checkboxes"></div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Konsensusgrad:</label>
          <select class="filter-select" id="consensus-filter" onchange="applyFilters()">
            <option value="">Alla niv√•er</option>
            <option value="high">H√∂g konsensus (80%+)</option>
            <option value="medium">Medel konsensus (50-79%)</option>
            <option value="low">L√•g konsensus (&lt;50%)</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Kommentarer:</label>
          <select class="filter-select" id="comment-filter" onchange="applyFilters()">
            <option value="">Alla uppdrag</option>
            <option value="with-comments">Endast med kommentarer</option>
            <option value="without-comments">Endast utan kommentarer</option>
          </select>
        </div>
      </div>
    </div>
  </main>

  <script>
    // API konfiguration
    const API_URL = 'https://script.google.com/macros/s/AKfycbzyiWEx_vT0n5ydQdA3u5C35D-O69JNBLkYGEWfRu8gKGxEsHodujZjYY6EQ9Vxlk0S/exec';

    let allUppdrag = [];
    let allResponses = [];
    let filteredResponses = [];
    let currentUppdragId = 1;
    let charts = {};
    let allF√∂rvaltningar = new Set();

    // JSONP helper
    function jsonp(url){
      return new Promise((resolve) => {
        const cb = 'jsonp_callback_' + Math.round(Math.random()*1e9);
        const script = document.createElement('script');
        const sep = url.includes('?') ? '&' : '?';
        window[cb] = (data) => { delete window[cb]; document.head.removeChild(script); resolve(data); };
        script.onerror = () => { delete window[cb]; document.head.removeChild(script); resolve(null); };
        script.src = `${url}${sep}callback=${cb}`;
        document.head.appendChild(script);
      });
    }

    // Ladda all data
    async function loadAllData() {
      try {
        document.getElementById('main-loading').style.display = 'block';
        await loadUppdrag();
        await loadAllResponses();
        extractF√∂rvaltningar();
        setupFilters();
        updateOverallStats();
        createUppdragTabs();
        await ensureCurrentTabVisibleAndLoad();
        generateInsights();
        createResponsibilityMatrix();
      } catch (error) {
        console.error('Fel vid laddning:', error);
        document.getElementById('main-loading').innerHTML = '<div class="error">Kunde inte ladda data. Kontrollera anslutningen.</div>';
      } finally {
        document.getElementById('main-loading').style.display = 'none';
      }
    }

    // Ladda uppdrag (faktarutor)
    async function loadUppdrag() {
      const data = await jsonp(`${API_URL}?action=get_fact_boxes`);
      if (Array.isArray(data)) {
        allUppdrag = data;
      } else {
        allUppdrag = [];
      }
    }

    // Ladda ALLA svar p√• en g√•ng
    async function loadAllResponses() {
      const data = await jsonp(`${API_URL}?action=get_all_responses`);
      if (Array.isArray(data)) {
        // Mappar kolumner: 0..6 ‚Üí timestamp, session_id, box_id, q1, q2, q3, updated_at
        const responses = data.map(row => ({
          timestamp: row[0],
          session_id: row[1],
          box_id: row[2],
          huvudansvar: row[3],
          st√∂d: row[4],
          kommentar: row[5],
          updated_at: row[6] || null
        })).filter(r => r.timestamp && r.session_id);
        allResponses = responses;
        filteredResponses = [...allResponses];
        console.log(`Optimerat: Laddade ${allResponses.length} svar i ett enda anrop`);
      } else {
        allResponses = [];
        filteredResponses = [];
      }
    }

    // Extrahera alla f√∂rvaltningar
    function extractF√∂rvaltningar() {
      allF√∂rvaltningar = new Set();
      allResponses.forEach(response => {
        if (response.huvudansvar) allF√∂rvaltningar.add(response.huvudansvar.trim());
        if (response.st√∂d) response.st√∂d.split(',').forEach(f => allF√∂rvaltningar.add(f.trim()));
      });
      // fr√•n uppdrag-definitionerna
      allUppdrag.forEach(uppdrag => {
        if (uppdrag.q1_options) uppdrag.q1_options.split(',').forEach(o => allF√∂rvaltningar.add(o.trim()));
        if (uppdrag.q2_options) uppdrag.q2_options.split(',').forEach(o => allF√∂rvaltningar.add(o.trim()));
      });
    }

    // S√§tt upp filtreringar
    function setupFilters() {
      const mainFilter = document.getElementById('main-responsibility-filter');
      mainFilter.innerHTML = '<option value="">Alla f√∂rvaltningar</option>';
      [...allF√∂rvaltningar].sort().forEach(f => {
        const option = document.createElement('option');
        option.value = f; option.textContent = f; mainFilter.appendChild(option);
      });

      const supportContainer = document.getElementById('support-filter-checkboxes');
      supportContainer.innerHTML = '';
      [...allF√∂rvaltningar].sort().forEach(f => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'filter-checkbox';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox'; checkbox.id = `support-${f}`; checkbox.value = f; checkbox.onchange = applyFilters;
        const label = document.createElement('label');
        label.htmlFor = `support-${f}`; label.textContent = f;
        checkboxDiv.appendChild(checkbox); checkboxDiv.appendChild(label);
        supportContainer.appendChild(checkboxDiv);
      });
    }

    // Till√§mpa filtreringar
    async function applyFilters() {
      const mainFilter = document.getElementById('main-responsibility-filter').value;
      const consensusFilter = document.getElementById('consensus-filter').value;
      const commentFilter = document.getElementById('comment-filter').value;

      const selectedSupport = [];
      document.querySelectorAll('#support-filter-checkboxes input[type="checkbox"]:checked').forEach(cb => selectedSupport.push(cb.value));

      filteredResponses = allResponses.filter(response => {
        if (mainFilter && response.huvudansvar !== mainFilter) return false;
        if (selectedSupport.length > 0) {
          const responseSupport = response.st√∂d ? response.st√∂d.split(',').map(s => s.trim()) : [];
          const hasMatchingSupport = selectedSupport.some(support => responseSupport.includes(support));
          if (!hasMatchingSupport) return false;
        }
        if (commentFilter === 'with-comments' && (!response.kommentar || !response.kommentar.trim())) return false;
        if (commentFilter === 'without-comments' && (response.kommentar && response.kommentar.trim())) return false;
        return true;
      });

      if (consensusFilter) {
        const filteredUppdragIds = new Set();
        allUppdrag.forEach(uppdrag => {
          const uppdragResponses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
          if (uppdragResponses.length > 0) {
            const consensus = calculateConsensus(uppdragResponses, 'huvudansvar');
            if (consensusFilter === 'high' && consensus >= 80) filteredUppdragIds.add(uppdrag.box_id);
            else if (consensusFilter === 'medium' && consensus >= 50 && consensus < 80) filteredUppdragIds.add(uppdrag.box_id);
            else if (consensusFilter === 'low' && consensus < 50) filteredUppdragIds.add(uppdrag.box_id);
          }
        });
        if (filteredUppdragIds.size > 0) {
          filteredResponses = filteredResponses.filter(r => filteredUppdragIds.has(r.box_id));
        }
      }

      updateOverallStats();
      createResponsibilityMatrix();
      createUppdragTabs();
      await ensureCurrentTabVisibleAndLoad();
      generateInsights();
    }

    // Ber√§kna konsensus
    function calculateConsensus(responses, field) {
      if (responses.length === 0) return 0;
      const counts = {}; let maxCount = 0;
      responses.forEach(response => {
        const value = response[field];
        if (value) { counts[value] = (counts[value] || 0) + 1; maxCount = Math.max(maxCount, counts[value]); }
      });
      return Math.round((maxCount / responses.length) * 100);
    }

    // √ñvergripande statistik
    function updateOverallStats() {
      const uniqueUppdrag = new Set(filteredResponses.map(r => r.box_id)).size;
      const totalResponses = filteredResponses.length;
      const uniqueParticipants = new Set(filteredResponses.map(r => r.session_id)).size;

      let totalConsensus = 0; let uppdragWithResponses = 0;
      allUppdrag.forEach(uppdrag => {
        const uppdragResponses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (uppdragResponses.length > 0) { totalConsensus += calculateConsensus(uppdragResponses, 'huvudansvar'); uppdragWithResponses++; }
      });
      const avgConsensus = uppdragWithResponses > 0 ? Math.round(totalConsensus / uppdragWithResponses) : 0;

      document.getElementById('total-assignments').textContent = uniqueUppdrag;
      document.getElementById('total-responses').textContent = totalResponses;
      document.getElementById('unique-participants').textContent = uniqueParticipants;
      document.getElementById('avg-consensus').textContent = avgConsensus + '%';
    }

    // Tabs
    function createUppdragTabs() {
      const tabsContainer = document.getElementById('uppdrag-tabs');
      tabsContainer.innerHTML = '';
      const relevantUppdrag = allUppdrag.filter(uppdrag => filteredResponses.some(r => r.box_id == uppdrag.box_id));
      relevantUppdrag.forEach(uppdrag => {
        const responseCount = filteredResponses.filter(r => r.box_id == uppdrag.box_id).length;
        const tab = document.createElement('button');
        tab.className = 'tab';
        tab.textContent = `${uppdrag.title}`;
        tab.onclick = (e) => selectUppdrag(uppdrag.box_id, e);
        if (uppdrag.box_id === currentUppdragId) tab.classList.add('active');
        if (responseCount > 0) {
          const badge = document.createElement('span');
          badge.className = 'tab-badge';
          badge.textContent = responseCount;
          tab.appendChild(badge);
        }
        tabsContainer.appendChild(tab);
      });
    }

    async function ensureCurrentTabVisibleAndLoad() {
      const visibleIds = new Set(filteredResponses.map(r => r.box_id));
      if (!visibleIds.has(currentUppdragId)) {
        const first = [...visibleIds][0];
        if (first != null) currentUppdragId = first;
      }
      await loadUppdragData(currentUppdragId);
      // markera aktiv tab
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      const tabs = [...document.querySelectorAll('.uppdrag-tabs .tab')];
      const idx = allUppdrag.findIndex(u => u.box_id == currentUppdragId);
      // fallback: markera f√∂rsta
      (tabs[idx] || tabs[0])?.classList.add('active');
    }

    async function selectUppdrag(uppdragId, e) {
      currentUppdragId = uppdragId;
      if (e && e.currentTarget) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        e.currentTarget.classList.add('active');
      }
      await loadUppdragData(uppdragId);
    }

    // Ladda data f√∂r specifikt uppdrag
    async function loadUppdragData(uppdragId) {
      const uppdrag = allUppdrag.find(u => u.box_id == uppdragId);
      const responses = filteredResponses.filter(r => r.box_id == uppdragId);
      if (!uppdrag || responses.length === 0) {
        document.getElementById('text-responses').innerHTML = '<div class="response-item">Inga svar f√∂r detta uppdrag.</div>';
        return;
      }
      displayComments(responses);
    }

    // Visa kommentarer (visar updated_at om finns)
    function displayComments(responses) {
      const container = document.getElementById('text-responses');
      const commentsWithText = responses.filter(r => r.kommentar && r.kommentar.trim());
      if (commentsWithText.length === 0) {
        container.innerHTML = '<div class="response-item">Inga kommentarer f√∂r detta uppdrag.</div>';
        return;
      }
      container.innerHTML = commentsWithText.map((response, index) => {
        const dateStr = new Date(response.updated_at || response.timestamp).toLocaleDateString('sv-SE');
        return `
          <div class="response-item">
            <div class="response-meta">
              <div><strong>Deltagare ${index + 1}</strong> ‚Ä¢ ${dateStr}</div>
              <div class="response-tags">
                <span class="response-tag">Huvudansvar: ${response.huvudansvar || 'Ej angivet'}</span>
                <span class="response-tag">St√∂d: ${response.st√∂d || 'Ej angivet'}</span>
              </div>
            </div>
            <div class="response-text">${response.kommentar}</div>
          </div>
        `;
      }).join('');
    }

    // Skapa ansvarsmatris (exakt r√§kning av st√∂d)
    function createResponsibilityMatrix() {
      const table = document.getElementById('responsibility-matrix');
      let headerHtml = '<thead><tr><th>Politiskt Uppdrag</th>';
      const sortedF√∂rvaltningar = [...allF√∂rvaltningar].sort();
      sortedF√∂rvaltningar.forEach(f => { headerHtml += `<th>${f}</th>`; });
      headerHtml += '<th>Konsensus</th></tr></thead>';

      let bodyHtml = '<tbody>';
      const relevantUppdrag = allUppdrag.filter(uppdrag => filteredResponses.some(r => r.box_id == uppdrag.box_id));

      relevantUppdrag.forEach(uppdrag => {
        const uppdragResponses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (uppdragResponses.length === 0) return;
        bodyHtml += `<tr><td><strong>${uppdrag.title}</strong></td>`;
        sortedF√∂rvaltningar.forEach(f => {
          const mainCount = uppdragResponses.filter(r => r.huvudansvar === f).length;
          const supportCount = uppdragResponses.filter(r => {
            if (!r.st√∂d) return false;
            const arr = r.st√∂d.split(',').map(s => s.trim()).filter(Boolean);
            return arr.includes(f);
          }).length;
          let cellContent = '';
          if (mainCount > 0) cellContent += `<span class="responsibility-badge badge-main">H: ${mainCount}</span>`;
          if (supportCount > 0) cellContent += `<span class="responsibility-badge badge-support">S: ${supportCount}</span>`;
          if (!cellContent) cellContent = '-';
          bodyHtml += `<td><div class="matrix-cell">${cellContent}</div></td>`;
        });
        const consensus = calculateConsensus(uppdragResponses, 'huvudansvar');
        bodyHtml += `<td><strong>${consensus}%</strong></td></tr>`;
      });
      bodyHtml += '</tbody>';
      table.innerHTML = headerHtml + bodyHtml;
    }

    // Strategiska insikter
    function generateInsights() {
      const consensusLevels = { high: 0, medium: 0, low: 0 };
      const f√∂rvaltningPopularity = {};
      allUppdrag.forEach(uppdrag => {
        const responses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (responses.length > 0) {
          const consensus = calculateConsensus(responses, 'huvudansvar');
          if (consensus >= 80) consensusLevels.high++;
          else if (consensus >= 50) consensusLevels.medium++;
          else consensusLevels.low++;
          responses.forEach(r => { if (r.huvudansvar) f√∂rvaltningPopularity[r.huvudansvar] = (f√∂rvaltningPopularity[r.huvudansvar] || 0) + 1; });
        }
      });

      const insightsData = [
        { icon: 'üéØ', text: `${consensusLevels.high} uppdrag har h√∂g konsensus (80%+), ${consensusLevels.low} har l√•g konsensus (&lt;50%)` },
        { icon: 'üë•', text: `${new Set(filteredResponses.map(r => r.session_id)).size} chefer har deltagit i kartl√§ggningen` }
      ];
      if (Object.keys(f√∂rvaltningPopularity).length > 0) {
        const mostPopular = Object.keys(f√∂rvaltningPopularity).reduce((a,b) => f√∂rvaltningPopularity[a] > f√∂rvaltningPopularity[b] ? a : b);
        insightsData.push({ icon: 'üèõÔ∏è', text: `${mostPopular} f√∂resl√•s som huvudansvarig f√∂r flest uppdrag` });
      }
      const commentsCount = filteredResponses.filter(r => r.kommentar && r.kommentar.trim()).length;
      if (commentsCount > 0) insightsData.push({ icon: 'üí¨', text: `${commentsCount} av ${filteredResponses.length} svar inneh√•ller kommentarer med f√∂rdjupade synpunkter` });

      const insightsContainer = document.getElementById('insights-grid');
      insightsContainer.innerHTML = insightsData.map(i => `
        <div class="insight-card">
          <div class="insight-icon">${i.icon}</div>
          <div class="insight-text">${i.text}</div>
        </div>
      `).join('');
    }

    // Exporter
    function exportResponsibilityMatrix() {
      const sortedF√∂rvaltningar = [...allF√∂rvaltningar].sort();
      let csv = 'Politiskt Uppdrag,' + sortedF√∂rvaltningar.join(',') + ',Konsensus\n';
      allUppdrag.forEach(uppdrag => {
        const responses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (responses.length === 0) return;
        csv += `"${uppdrag.title}",`;
        sortedF√∂rvaltningar.forEach(f => {
          const mainCount = responses.filter(r => r.huvudansvar === f).length;
          const supportCount = responses.filter(r => {
            if (!r.st√∂d) return false;
            const arr = r.st√∂d.split(',').map(s => s.trim()).filter(Boolean);
            return arr.includes(f);
          }).length;
          let cellValue = '';
          if (mainCount > 0) cellValue += `H:${mainCount}`;
          if (supportCount > 0) cellValue += `${cellValue ? ' ' : ''}S:${supportCount}`;
          if (!cellValue) cellValue = '-';
          csv += `"${cellValue}",`;
        });
        const consensus = calculateConsensus(responses, 'huvudansvar');
        csv += `${consensus}%\n`;
      });
      downloadCSV(csv, 'ansvarsmatris_politiska_uppdrag.csv');
    }

    function exportDetailedAnalysis() {
      let csv = 'Uppdrag,Titel,Deltagare,Huvudansvar,St√∂df√∂rvaltningar,Kommentar,Datum,Senast uppdaterad\n';
      filteredResponses.forEach(response => {
        const uppdrag = allUppdrag.find(u => u.box_id == response.box_id);
        const ts = response.timestamp ? new Date(response.timestamp).toISOString() : '';
        const up = response.updated_at ? new Date(response.updated_at).toISOString() : '';
        csv += `"${response.box_id}","${uppdrag ? uppdrag.title : 'Ok√§nd'}","${response.session_id}","${response.huvudansvar}","${response.st√∂d}","${(response.kommentar || '').replace(/"/g,'""')}","${ts}","${up}"\n`;
      });
      downloadCSV(csv, 'detaljerad_analys_politiska_uppdrag.csv');
    }

    function exportExecutiveSummary() {
      alert('PDF-export med chefssammanfattning kommer att implementeras med avancerade insikter och rekommendationer.');
    }

    function exportConsensusReport() {
      let report = 'KONSENSUSRAPPORT - POLITISKA UPPDRAG\n';
      report += `Genererad: ${new Date().toLocaleDateString('sv-SE')}\n\n`;
      allUppdrag.forEach(uppdrag => {
        const responses = filteredResponses.filter(r => r.box_id == uppdrag.box_id);
        if (responses.length === 0) return;
        const consensus = calculateConsensus(responses, 'huvudansvar');
        const level = consensus >= 80 ? 'H√ñG' : consensus >= 50 ? 'MEDEL' : 'L√ÖG';
        report += `${uppdrag.title}: ${consensus}% konsensus (${level})\n`;
        const counts = {};
        responses.forEach(r => { if (r.huvudansvar) counts[r.huvudansvar] = (counts[r.huvudansvar] || 0) + 1; });
        Object.entries(counts).sort(([,a],[,b]) => b - a).forEach(([f, count]) => {
          const percentage = Math.round((count / responses.length) * 100);
          report += `  - ${f}: ${count} r√∂ster (${percentage}%)\n`;
        });
        report += '\n';
      });
      const blob = new Blob([report], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      a.download = `konsensusrapport_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url);
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url);
    }

    document.addEventListener('DOMContentLoaded', function(){ loadAllData(); });
  </script>
</body>
</html>
